name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  package-and-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine pylint
          python -m pip install -e ".[test]"

      - name: Build package
        run: python -m build

      - name: Verify metadata
        run: python -m twine check dist/*

      - name: Lint
        run: pylint src/blender_mcp addon --rcfile=.pylintrc || true

      - name: Run core tests
        run: |
          pytest tests/unit -q
          pytest tests/test_server.py -q
          pytest tests/test_cli.py -q
          pytest tests/test_e2e_addon_server.py -q

  gui-and-visual:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[gui,test]"

      - name: Run GUI and visual tests
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          pytest tests/test_gui.py -q
          pytest tests/visual/test_gui_visual_regression.py -q

      - name: Capture GUI snapshot artifact
        if: always()
        env:
          QT_QPA_PLATFORM: offscreen
          BLENDER_MCP_VISUAL_ARTIFACT: visual-artifacts/gui_current.png
        run: python tests/visual/capture_gui_snapshot.py

      - name: Upload GUI visual artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gui-visual-artifacts
          path: visual-artifacts/

  windows-blender-e2e:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[test]"

      - name: Install Blender
        shell: powershell
        run: |
          choco install blender -y --no-progress

      - name: Resolve Blender executable
        shell: powershell
        run: |
          $candidate = Get-ChildItem "C:\Program Files\Blender Foundation" -Recurse -Filter blender.exe -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if ($candidate) {
            "BLENDER_EXE=$($candidate.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Resolved BLENDER_EXE=$($candidate.FullName)"
          } else {
            Write-Host "Blender executable not found after installation. Test will self-skip."
          }

      - name: Run Blender E2E smoke test
        run: pytest tests/test_e2e_addon_server.py -q
